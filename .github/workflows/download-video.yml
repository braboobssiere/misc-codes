name: Download Video

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "Video URL to download"
        required: true    
      vpn_enabled:
        description: 'Enable VPN connection?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
        
jobs:
  download_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create requirements.txt
        run: echo "yt-dlp" > requirements.txt

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create output directory
        run: mkdir -p output

      - name: Get non-VPN Public IP
        id: check_nonvpn_ip
        run: |
          NON_VPN_IP=$(curl -s https://api.ipify.org)
          echo "Non VPN IP: ${NON_VPN_IP}"

      - name: Install OpenVPN 
        if: ${{ github.event.inputs.vpn_enabled == 'true' }}
        run: |
          sudo apt-get install -y openvpn openvpn-systemd-resolved

      - name: Deploy VPN configuration file
        if: ${{ github.event.inputs.vpn_enabled == 'true' }}
        run: |
          echo "${{ secrets.OPENVPN_CONFIG }}" > vpnconfig.ovpn
                 
      - name: Connect to VPN
        if: ${{ github.event.inputs.vpn_enabled == 'true' }}
        uses: "kota65535/github-openvpn-connect-action@v3"
        with:
          config_file: vpnconfig.ovpn
          username: ${{ secrets.OPENVPN_USERNAME }}
          password: ${{ secrets.OPENVPN_PASSWORD }}
          
      - name: Check for VPN IP Change
        if: ${{ github.event.inputs.vpn_enabled == 'true' }}
        run: |
          VPN_IP=$(curl -s https://api.ipify.org)
          echo "Current public IP: $VPN_IP"

      - name: Write YouTube cookie file if needed
        run: |
          if [[ "${{ github.event.inputs.video_url }}" == *"youtube.com"* || "${{ github.event.inputs.video_url }}" == *"youtu.be"* ]]; then
            echo "Detected YouTube URL. Writing cookies file..."
            echo "${{ secrets.YT_COOKIES }}" > cookies.txt
          else
            echo "Non-YouTube URL detected. Not writing cookies file."
          fi

      - name: Download video with yt-dlp into output folder
        run: |
          URL="${{ github.event.inputs.video_url }}"
          LIVE_FLAGS=""
    
          if [[ "$URL" == *"youtube.com"* || "$URL" == *"youtu.be"* ]]; then
            echo "Detected YouTube URL, checking live status"
            LIVE_STATUS=$(yt-dlp --print live_status "$URL")
      
            if [[ "$LIVE_STATUS" == "is_live" || "$LIVE_STATUS" == "post_live" ]]; then
              LIVE_FLAGS="--live-from-start"
              echo "Live stream detected, adding --live-from-start flag"
            fi
      
            yt-dlp --cookies cookies.txt $LIVE_FLAGS --windows-filenames -f "bestvideo[height<=1080]+bestaudio/best" -o "output/%(title)s.%(ext)s" "$URL"
          else
            echo "Non-YouTube URL detected, proceeding without cookies or live flags"
            yt-dlp --windows-filenames -f "bestvideo[height<=1080]+bestaudio/best" -o "output/%(title)s.%(ext)s" "$URL"
          fi

          echo "Download complete. Listing files in output directory:"
          ls -lh output

      - name: Check and Remux video with ffmpeg if needed
        run: |
          for file in output/*; do
            video_streams=$(ffprobe -v error -select_streams v -show_entries stream=codec_type -of csv=p=0 "$file" | grep -c video)
            audio_streams=$(ffprobe -v error -select_streams a -show_entries stream=codec_type -of csv=p=0 "$file" | grep -c audio)

            if [[ "$video_streams" -gt 0 && "$audio_streams" -gt 0 ]]; then
              echo "$file already has both video and audio streams. Skipping remux."
            else
              output_file="${file%.*}.mp4"
              echo "Remuxing $file to $output_file"
              ffmpeg -i "$file" -c copy "$output_file"
              rm "$file"
              echo "Removed original file: $file"
            fi
          done
          echo "Check and remuxing complete. Listing files in output directory:"
          ls -lh output

      - name: Rename files in specified format
        run: |
          for file in output/*; do
            title=$(basename "$file" | sed 's/\.[^.]*$//')  # Get the title without extension
            
            # Extract resolution and codec using ffprobe
            resolution=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of csv=p=0 "$file")
            codec=$(ffprobe -v error -select_streams v:0 -show_entries stream=codec_name -of csv=p=0 "$file")

            # Format resolution and codec
            if [[ -n "$resolution" ]]; then
              resolution="${resolution}p"
            else
              resolution="unknown"
            fi
            
            new_name="${title} (${resolution}, ${codec}).mp4"
            mv "$file" "output/$new_name"
            echo "Renamed $file to $new_name"
          done
          echo "Renaming complete. Listing files in output directory:"
          ls -lh output

      - name: Upload output directory as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-video
          path: output
          retention-days: 7
          compression-level: 1
          if-no-files-found: error
