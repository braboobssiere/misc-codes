name: IG Download
on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Instagram profile to download'
        required: true
      login:
        description: 'Use login'
        type: boolean
        default: false


permissions:
  contents: write

jobs:
  download:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout stamps file
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: ./input/instaloader/

      - name: Maximize space
        uses: easimon/maximize-build-space@v10
        with:
          swap-size-mb: 10240

      - name: Setup Dependencies
        run: |
          python -m pip install --upgrade pip
          pip3 install --upgrade instaloader fake-useragent
          sudo apt-get update
          sudo apt-get install -y wireguard-tools

      - name: VPN Setup 
        env: 
          PRIMARY_CONFIG: ${{ secrets.WIREGUARD_MARINABAY }}
          SECONDARY_CONFIG: ${{ secrets.WIREGUARD_TRADEWAR }}
        run: |
          sudo mkdir -p /etc/wireguard/
          WG_CONF="/etc/wireguard/wg0.conf"

          handle_vpn_attempt() {
            local config_content="$1"
            local label="$2"
            
            echo "$config_content" | sudo tee $WG_CONF > /dev/null
            sudo chmod 600 $WG_CONF

            for i in {1..3}; do
              if timeout 60 sudo wg-quick up wg0; then
                return 0
              fi
              echo "${label^} VPN attempt $i/3 failed"
              sleep 3
            done
            return 1
          }

          if ! handle_vpn_attempt "$PRIMARY_CONFIG" "primary"; then
            echo "::warning::Primary failed - Trying secondary"
            if ! handle_vpn_attempt "$SECONDARY_CONFIG" "secondary"; then
              echo "::error::All VPN configurations failed after 3 attempts each"
              exit 11
            fi
          fi

          if ! sudo wg show wg0 >/dev/null 2>&1; then
            echo "::error::VPN connection verification failed"
            exit 12
          fi

      - name: Generate User-Agent
        id: ua_gen
        run: |
          echo "user_agent=$(python - <<'PY'
          from fake_useragent import UserAgent
          print(UserAgent(platforms=['desktop']).random)
          PY
          )" >> $GITHUB_OUTPUT


      - name: Download profile
        id: download
        continue-on-error: true
        env:
          UA: ${{ steps.ua_gen.outputs.user_agent }}
        run: |
          PROFILE="${{ inputs.profile }}"
          STAMPS_FILE="./input/instaloader/latest-stamps.ini"
          if [ "${{ inputs.login }}" = "true" ]; then
            echo "${{ secrets.IG_SESSION_BASE64 }}" | base64 -d > IG_SESSION
            instaloader profile $PROFILE --sanitize-paths --no-captions \
            --no-metadata-json --user-agent "$UA" --latest-stamps "$STAMPS_FILE" \
            --login ${{ secrets.IG_USERNAME }} --sessionfile IG_SESSION
          else
            instaloader profile $PROFILE --sanitize-paths --no-captions \
            --no-metadata-json --user-agent "$UA" --latest-stamps "$STAMPS_FILE"
          fi

      - name: Zip file 
        run: |
          PROFILE="${{ inputs.profile }}"
          mkdir -p output
    
          FOLDER_TO_ZIP=""
          for dir in */; do
            dir=${dir%/}  
      
            if [[ "${dir,,}" == *"${PROFILE,,}"* ]]; then
              if find "$dir" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) | head -1 | grep -q .; then
                FOLDER_TO_ZIP="$dir"
                break
              fi
            fi
          done
    
          if [[ -n "$FOLDER_TO_ZIP" ]]; then
            zip -1 -r -m -s 2g "output/${PROFILE}.zip" "$FOLDER_TO_ZIP"
          else
            echo "Warning: No folder containing '$PROFILE' with image files found"
            echo "Available directories:"
            ls -la
            exit 13
          fi

      - name: VPN Cleanup
        if: ${{ always() }}
        run: sudo wg-quick down wg0 || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: instagram-${{ inputs.profile }}
          path: output/

      - name: Upload Files to Cloud Storage
        run: |
          UPLOAD_URL="https://upload.gofile.io/uploadfile"
          guest_token=""
          folder_id=""
          UPLOAD_LINKS=""
          TITLE=""
          FIRST_FILE=true
          PROFILE="${{ inputs.profile }}"

          while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            if [[ "$filename" != *.txt ]] && [[ -z "$TITLE" ]]; then
              TITLE="${filename%.*}" 
            fi
            echo "Starting upload: $(basename "$file")"
            extra_args=()
            if [ "$FIRST_FILE" = false ]; then
              extra_args+=(-H "Authorization: Bearer $guest_token" -F "folderId=$folder_id")
            fi
            
            RESPONSE=$(curl -s -X POST -F "file=@\"$file\"" "${extra_args[@]}" "$UPLOAD_URL")

            PYTHON_OUTPUT=$(python3 <<EOF
          import json, sys
          try:
              data = json.loads('''$RESPONSE''')
              if "$FIRST_FILE" == "true":
                  guest_token = data['data']['guestToken']
                  folder_id = data['data']['parentFolder']
                  print(f"{guest_token}\t{folder_id}")
              else:
                  print("-\t-")          
              status = 'ok' if data['status'] == 'ok' else 'error'
              result_data = data.get('data', {}).get('downloadPage', '') if status == 'ok' else data.get('data', '')
              print(f"{status}\t{result_data}")
          except Exception as e:
              print(f"error\tJSON parsing failed: {str(e)}")
              sys.exit(14)
          EOF
            )

            {
              read -r token_part folder_part
              read -r status_type result_data
            } <<< "$PYTHON_OUTPUT"

            if [ "$FIRST_FILE" = true ]; then
              guest_token="$token_part"
              folder_id="$folder_part"
              FIRST_FILE=false
              echo "GUEST_TOKEN=$guest_token" >> $GITHUB_ENV
              echo "FOLDER_ID=$folder_id" >> $GITHUB_ENV
              echo "Created folder ID"
            fi

            if [ "$status_type" != "ok" ]; then
              echo "::error file=$file::Upload failed: $result_data"
            else
              LINK="$result_data"
              UPLOAD_LINKS+="- $(basename "$file")\n"
              echo "Success: $LINK"
            fi
          done < <(find output -type f -print0)

          echo "### Profile $PROFILE File Uploads: $LINK" >> $GITHUB_STEP_SUMMARY

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"Profile $PROFILE File Uploads: $LINK \"}" \
            "${{ secrets.DISCORD_WEBHOOK }}"
         
      - name: Commit stamps file
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"
          git add input/instaloader/latest-stamps.ini
          git commit -m "Update latest-stamps" || echo "no changes to commit"
          git push
      
