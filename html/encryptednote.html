<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Encryption</title>
    <link rel="stylesheet" href="../css/encryptednote-styles.css">
    <style>
        .requirement {
            color: green;
        }
        .requirement.invalid {
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Markdown Encryption Tool</h1>
        <textarea id="markdownInput" placeholder="Enter your Markdown content here..."></textarea>
        <input type="password" id="passwordInput" placeholder="Enter a strong password" />
        <div id="passwordRequirements">
            <p>Password Requirements:</p>
            <ul>
                <li class="requirement" id="lengthRequirement">At least 16 characters long</li>
                <li class="requirement" id="uppercaseRequirement">At least 1 uppercase letter</li>
                <li class="requirement" id="lowercaseRequirement">At least 1 lowercase letter</li>
                <li class="requirement" id="numberRequirement">At least 1 number</li>
                <li class="requirement" id="specialCharRequirement">At least 1 special character (e.g., !@#$%^&*()_+-=;:'"\\|,.<>/?~`•^°)</li>
            </ul>
        </div>
        <button id="encryptButton">Encrypt</button>
        <button id="decryptButton">Decrypt</button>
        <button id="importButton">Import from Text File</button>
        <input type="file" id="fileInput" style="display: none;" accept=".txt" />
        <button id="exportButton">Export Encrypted Data</button>
        <textarea id="output" placeholder="Output will appear here..." readonly></textarea>
    </div>
    <script>
        async function deriveKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveBits", "deriveKey"]
            );

            return window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-CBC", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        async function encrypt(plaintext, password) {
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(16));
            const key = await deriveKey(password, salt);

            const enc = new TextEncoder();
            const paddedPlaintext = pad(plaintext);
            const ciphertext = await window.crypto.subtle.encrypt(
                {
                    name: "AES-CBC",
                    iv: iv
                },
                key,
                enc.encode(paddedPlaintext)
            );

            return {
                salt: Array.from(salt),
                iv: Array.from(iv),
                ciphertext: arrayBufferToBase64(ciphertext) // Convert to Base64 directly
            };
        }

        async function decrypt(encryptedData, password) {
            const salt = new Uint8Array(encryptedData.salt);
            const iv = new Uint8Array(encryptedData.iv);
            const ciphertext = base64ToArrayBuffer(encryptedData.ciphertext); // Convert from Base64
            const key = await deriveKey(password, salt);

            const decrypted = await window.crypto.subtle.decrypt(
                {
                    name: "AES-CBC",
                    iv: iv
                },
                key,
                ciphertext
            );

            const dec = new TextDecoder();
            return unpad(dec.decode(decrypted));
        }

        function pad(plaintext) {
            const blockSize = 16;
            const padding = blockSize - (plaintext.length % blockSize);
            return plaintext + String.fromCharCode(padding).repeat(padding);
        }

        function unpad(padded) {
            const padding = padded.charCodeAt(padded.length - 1);
            return padded.slice(0, padded.length - padding);
        }

        document.getElementById("encryptButton").addEventListener("click", async () => {
            const markdownInput = document.getElementById("markdownInput").value;
            const passwordInput = document.getElementById("passwordInput").value;

            const passwordValidationMessages = isStrongPassword(passwordInput);
            if (passwordValidationMessages.length > 0) {
                document.getElementById("output").value = "Password does not meet the following requirements:\n" + passwordValidationMessages.join("\n");
                return;
            }

            const encryptedData = await encrypt(markdownInput, passwordInput);
            document.getElementById("output").value = JSON.stringify(encryptedData);
        });

        document.getElementById("decryptButton").addEventListener("click", async () => {
            const encryptedData = JSON.parse(document.getElementById("output").value);
            const passwordInput = document.getElementById("passwordInput").value;

            try {
                const decryptedText = await decrypt(encryptedData, passwordInput);
                document.getElementById("output").value = decryptedText;
            } catch (error) {
                document.getElementById("output").value = "Decryption failed. Please check your password.";
            }
        });

        document.getElementById("exportButton").addEventListener("click", async () => {
            const outputValue = document.getElementById("output").value;
            const passwordInput = document.getElementById("passwordInput").value;
            let dataToExport;

            // Check if the output is encrypted data
            try {
                const encryptedData = JSON.parse(outputValue);
                if (encryptedData.salt && encryptedData.iv && encryptedData.ciphertext) {
                    // Output is encrypted data
                    dataToExport = outputValue;
                } else {
                    throw new Error("Not encrypted data");
                }
            } catch (error) {
                // Output is not encrypted, check if input is encrypted
                const markdownInput = document.getElementById("markdownInput").value;
                try {
                    const inputEncryptedData = JSON.parse(markdownInput);
                    if (inputEncryptedData.salt && inputEncryptedData.iv && inputEncryptedData.ciphertext) {
                        // Input is encrypted data
                        dataToExport = JSON.stringify(inputEncryptedData);
                    } else {
                        // Neither output nor input is encrypted, encrypt the input
                        dataToExport = JSON.stringify(await encrypt(markdownInput, passwordInput));
                    }
                } catch (error) {
                    // If input is not valid JSON, encrypt the input
                    dataToExport = JSON.stringify(await encrypt(markdownInput, passwordInput));
                }
            }

            // Create a timestamp for the file name
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-'); // Replace colons and dots for valid filename
            const fileName = `encrypted_data_${timestamp}.txt`;

            // Create a blob and download the data
            const blob = new Blob([dataToExport], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName; // Use the timestamped file name
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById("importButton").addEventListener("click", () => {
            document.getElementById("fileInput").click(); // Trigger the file input click
        });

        document.getElementById("fileInput").addEventListener("change", (event) => {
            const file = event.target.files[0]; // Get the selected file
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result; // Get the file content
                    document.getElementById("markdownInput").value = content; // Set the content to the textarea
                    
                    // Manually trigger the input event to process the content
                    document.getElementById("markdownInput").dispatchEvent(new Event('input'));
                };
                reader.readAsText(file); // Read the file as text
            }
        });

        function isValidPasswordCharacters(password) {
            // Define the regex for allowed characters (letters, numbers, and special characters)
            const allowedCharsRegex = /^[A-Za-z0-9!@#$%^&*()_+\-=${};':"\\|,.<>\/?~`•^°]*$/;
            const invalidChars = [...password].filter(char => !allowedCharsRegex.test(char));
            return invalidChars;
        }

        document.getElementById("passwordInput").addEventListener("input", () => {
            const passwordInput = document.getElementById("passwordInput").value;

            // Check for invalid characters
            const invalidChars = isValidPasswordCharacters(passwordInput);
            if (invalidChars.length > 0) {
                document.getElementById("output").value = "Invalid characters detected in password: " + invalidChars.join(", ") + "\n" +
                    "Please use only:\n" +
                    "- Letters (A-Z, a-z)\n" +
                    "- Numbers (0-9)\n" +
                    "- Special characters (e.g., !@#$%^&*()_+-=;:'\"\\|,.<>/?~`•^°)\n" +
                    "Spaces are not allowed.";
                return;
            }

            // Check password strength and update requirements
            updatePasswordRequirements(passwordInput);
        });

        function updatePasswordRequirements(password) {
            // Reset all requirements to valid
            document.querySelectorAll('.requirement').forEach(req => req.classList.remove('invalid'));

            // Check password strength
            const messages = isStrongPassword(password);

            // If there are messages, show them in the output box
            if (messages.length > 0) {
                document.getElementById("output").value = "Password does not meet the following requirements:\n" + messages.join("\n");
            } else {
                document.getElementById("output").value = ""; // Clear output if all requirements are met
            }
        }

        function isStrongPassword(password) {
            const messages = [];

            // Check for minimum length
            if (password.length < 16) {
                messages.push("At least 16 characters long");
                document.getElementById("lengthRequirement").classList.add("invalid");
            } else {
                document.getElementById("lengthRequirement").classList.remove("invalid");
            }

            // Initialize counters for character types
            let hasUppercase = false;
            let hasLowercase = false;
            let hasNumber = false;
            let hasSpecialChar = false;

            // Define the regex for special characters
            const specialCharRegex = /[!@#$%^&*()_+\-=${};':"\\|,.<>\/?~`•^°]/;

            // Check each character in the password
            for (let char of password) {
                if (/[A-Z]/.test(char)) {
                    hasUppercase = true;
                } else if (/[a-z]/.test(char)) {
                    hasLowercase = true;
                } else if (/[0-9]/.test(char)) {
                    hasNumber = true;
                } else if (specialCharRegex.test(char)) {
                    hasSpecialChar = true;
                }
            }

            // Count how many character types are present
            const characterTypesCount = [hasUppercase, hasLowercase, hasNumber, hasSpecialChar].filter(Boolean).length;

            // Check for at least 3 character types
            if (characterTypesCount < 3) {
                if (!hasUppercase) {
                    messages.push("At least 1 uppercase letter");
                    document.getElementById("uppercaseRequirement").classList.add("invalid");
                }
                if (!hasLowercase) {
                    messages.push("At least 1 lowercase letter");
                    document.getElementById("lowercaseRequirement").classList.add("invalid");
                }
                if (!hasNumber) {
                    messages.push("At least 1 number");
                    document.getElementById("numberRequirement").classList.add("invalid");
                }
                if (!hasSpecialChar) {
                    messages.push("At least 1 special character (e.g., !@#$%^&*()_+-=;:'\"\\|,.<>/?~`•^°)");
                    document.getElementById("specialCharRequirement").classList.add("invalid");
                }
            } else {
                document.getElementById("uppercaseRequirement").classList.remove("invalid");
                document.getElementById("lowercaseRequirement").classList.remove("invalid");
                document.getElementById("numberRequirement").classList.remove("invalid");
                document.getElementById("specialCharRequirement").classList.remove("invalid");
            }

            return messages;
        }
    </script>
</body>
</html>
