<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yu-Gi-Oh Deck Extractor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        pre {
            white-space: pre-wrap; /* Preserve whitespace */
        }
    </style>
</head>
<body>
    <h1>Yu-Gi-Oh Deck Extractor</h1>
    <input type="text" id="deckUrl" placeholder="Enter Deck URL" />
    <button id="fetchDeck">Fetch Deck</button>
    <h2>Deck Output:</h2>
    <pre id="output"></pre>

    <script>
        // Global constants for card matching regex patterns
        const CARD_REGEX = /<td class="card_name">.*?<span>(.*?)<\/span>.*?<input type="hidden" class="link_value" value="\/yugiohdb\/card_search\.action\?.*?">.*?<td class="num">.*?<span>(.*?)<\/span>/gs;

        document.getElementById('fetchDeck').addEventListener('click', async () => {
            const urlInput = document.getElementById('deckUrl').value;
            let url = new URL(urlInput);

            // Handle request_locale
            if (url.searchParams.get('request_locale') === 'jp') {
                url.searchParams.set('request_locale', 'en');
            }

            try {
                const response = await fetch(url);
                const text = await response.text();
                const output = extractDeckList(text);
                document.getElementById('output').textContent = output;
            } catch (error) {
                console.error('Error fetching the deck:', error);
                document.getElementById('output').textContent = 'Error fetching the deck.';
            }
        });

        function extractDeckList(html) {
            const mainDeck = [];
            const extraDeck = [];
            const sideDeck = [];

            // Extract main deck
            const deckTextMatch = html.match(/<div id="deck_text">(.*?)<table id="extra_list" class="deck_list">/s);
            if (deckTextMatch) {
                const deckText = deckTextMatch[1];
                const cardMatches = deckText.matchAll(CARD_REGEX);
                for (const match of cardMatches) {
                    const cardName = match[1].trim();
                    const amount = match[2].trim();
                    mainDeck.push(`${amount} ${cardName}`);
                }
            }

            // Extract extra deck
            const extraDeckMatch = html.match(/<table id="extra_list" class="deck_list">(.*?)<table id="side_list" class="deck_list">/s);
            if (extraDeckMatch) {
                const extraText = extraDeckMatch[1];
                const extraCardMatches = extraText.matchAll(CARD_REGEX);
                for (const match of extraCardMatches) {
                    const cardName = match[1].trim();
                    const amount = match[2].trim();
                    extraDeck.push(`${amount} ${cardName}`);
                }
            }

            // Extract side deck
            const sideDeckMatch = html.match(/<table id="side_list" class="deck_list">(.*?)<\/div><!-- #deck_text -->/s);
            if (sideDeckMatch) {
                const sideText = sideDeckMatch[1];
                const sideCardMatches = sideText.matchAll(CARD_REGEX);
                for (const match of sideCardMatches) {
                    const cardName = match[1].trim();
                    const amount = match[2].trim();
                    sideDeck.push(`${amount} ${cardName}`);
                }
            }

            // Format output
            let output = '#main\n' + mainDeck.join('\n') + '\n\n#extra\n' + extraDeck.join('\n') + '\n\n!side\n' + sideDeck.join('\n');
            return output;
        }
    </script>
</body>
</html>
