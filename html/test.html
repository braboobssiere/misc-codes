<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yu-Gi-Oh Deck Extractor 0.1</title>
</head>
<body>
    <h1>Yu-Gi-Oh Deck Extractor</h1>
    <input type="text" id="deckUrl" placeholder="Enter Deck URL" />
    <button id="fetchDeck">Fetch Deck</button>
    <pre id="output"></pre>
    <button id="download" style="display:none;">Download Decklist</button>
    <button id="downloadLogs" style="display:none;">Download Fetch Logs</button>

    <script>
        document.getElementById('fetchDeck').addEventListener('click', async () => {
            const urlInput = document.getElementById('deckUrl').value;

            // Validate URL and modify locale
            const urlPattern = /^(https?:\/\/)?(www\.)?db\.yugioh-card\.com\/.+(&request_locale=(en|jp))$/;
            if (!urlPattern.test(urlInput)) {
                alert('Invalid URL. Please enter a valid Yu-Gi-Oh deck URL.');
                return;
            }

            const originalUrl = urlInput.replace(/&request_locale=jp/, '&request_locale=en');
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(originalUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const text = data.contents;

                // Log response details
                const logDetails = {
                    url: proxyUrl,
                    status: response.status,
                    headers: Array.from(response.headers.entries()).map(([key, value]) => `${key}: ${value}`).join('\n'),
                    body: text
                };
                console.log('Fetch Response:', logDetails);

                const mainDeck = extractDeck(text, 'deck_text', 'extra_list');
                const extraDeck = extractDeck(text, 'extra_list', 'side_list');
                const sideDeck = extractDeck(text, 'side_list', '');

                const output = formatDeck(mainDeck, extraDeck, sideDeck);
                document.getElementById('output').textContent = output;
                document.getElementById('download').style.display = 'block';
                document.getElementById('download').onclick = () => downloadFile(output);

                // Show log download button
                document.getElementById('downloadLogs').style.display = 'block';
                document.getElementById('downloadLogs').onclick = () => downloadFile(JSON.stringify(logDetails, null, 2), 'fetch_log.txt');

            } catch (error) {
                console.error('Error fetching the deck:', error);
            }
        });

        function extractDeck(html, startId, endId) {
            const startRegex = new RegExp(`<div id="${startId}"[^>]*>([\\s\\S]*?)`, 'i');
            const endRegex = endId ? new RegExp(`<table id="${endId}" class="deck_list">`, 'i') : /<\/div>\s*<!-- #deck_text -->/i;

            const startMatch = html.match(startRegex);
            if (!startMatch) return [];

            const endMatch = html.match(endRegex);
            const deckContent = html.substring(startMatch.index + startMatch[0].length, endMatch ? endMatch.index : html.length);

            const cardRegex = /<td class="card_name">[\s\S]*?<span>(.*?)<\/span>[\s\S]*?<td class="num">[\s\S]*?<span>(\d+)<\/span>/g;
            const cards = [];
            let cardMatch;

            while ((cardMatch = cardRegex.exec(deckContent)) !== null) {
                cards.push({ name: cardMatch[1].trim(), amount: cardMatch[2].trim() });
            }

            return cards;
        }

        function formatDeck(mainDeck, extraDeck, sideDeck) {
            let output = '#main\n';
            mainDeck.forEach(card => {
                output += `${card.amount} ${card.name}\n`;
            });

            output += '\n#extra\n';
            extraDeck.forEach(card => {
                output += `${card.amount} ${card.name}\n`;
            });

            output += '\n!side\n';
            sideDeck.forEach(card => {
                output += `${card.amount} ${card.name}\n`;
            });

            return output;
        }

        function downloadFile(content, filename = 'decklist.txt') {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
