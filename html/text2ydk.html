<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCGPlayer Text to YDK Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
        }
        button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>TCGPlayer Text to YDK Converter</h1>
    <form id="converterForm">
        <label for="fileInput">Select TCGPlayer text file:</label>
        <input type="file" id="fileInput" accept=".txt">
        <br><br>
        <label for="textInput">Or enter TCGPlayer text content:</label>
        <textarea id="textInput" placeholder="3 Tenpai Dragon Paidra&#10;3 Tenpai Dragon Chundra&#10;2 Tenpai Dragon Fadra&#10;&#10;1 Black Rose Dragon&#10;1 Odd-Eyes Meteorburst Dragon&#10;1 Promethean Princess, Bestower of Flames&#10;&#10;1 Koa'ki Meiru Drago&#10;1 Bystial Druiswurm"></textarea>
        <br>
        <button type="submit">Convert to YDK</button>
    </form>
    <div id="downloadLinkContainer" style="display:none;">
        <a id="downloadLink" href="#" download="deck.ydk">Download YDK File</a>
    </div>

    <script>
        document.getElementById('converterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const textInput = document.getElementById('textInput').value.trim();
            let inputText = '';

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = async (event) => {
                    inputText = event.target.result;
                    await processInput(inputText);
                };
                reader.readAsText(file);
            } else if (textInput) {
                inputText = textInput;
                await processInput(inputText);
            } else {
                alert('Please provide either a file or text input.');
            }
        });

        async function processInput(inputText) {
            const sections = inputText.split('\n\n\n').map(section => section.trim());
            const mainDeck = sections[0] ? sections[0].split('\n').map(line => line.trim()).filter(line => line) : [];
            const extraDeck = sections[1] ? sections[1].split('\n').map(line => line.trim()).filter(line => line) : [];
            const sideDeck = sections[2] ? sections[2].split('\n').map(line => line.trim()).filter(line => line) : [];

            const cardRequests = [
                ...mainDeck.map(line => {
                    const [quantity, ...cardNameParts] = line.split(' ');
                    const cardName = cardNameParts.join(' ');
                    return { quantity: parseInt(quantity), cardName, type: 'main' };
                }),
                ...extraDeck.map(line => {
                    const [quantity, ...cardNameParts] = line.split(' ');
                    const cardName = cardNameParts.join(' ');
                    return { quantity: parseInt(quantity), cardName, type: 'extra' };
                }),
                ...sideDeck.map(line => {
                    const [quantity, ...cardNameParts] = line.split(' ');
                    const cardName = cardNameParts.join(' ');
                    return { quantity: parseInt(quantity), cardName, type: 'side' };
                })
            ];

            const cardNames = cardRequests.map(card => encodeURIComponent(card.cardName)).join('|');
            const apiUrl = `https://db.ygoprodeck.com/api/v7/cardinfo.php?name=${cardNames}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.success) {
                    const ydkContent = generateYdkContent(data.data, cardRequests);
                    createDownloadLink(ydkContent);
                } else {
                    alert('Error fetching card data. Please check your input.');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('Error fetching card data. Please try again.');
            }
        }

        function generateYdkContent(cardData, cardRequests) {
            const ydkLines = [];
            ydkLines.push("#created by TCGPlayer Text to YDK Converter");

            // Main Deck
            ydkLines.push("#main");
            cardRequests.filter(req => req.type === 'main').forEach(request => {
                const cardInfo = cardData.find(card => card.name === request.cardName);
                if (cardInfo) {
                    for (let i = 0; i < request.quantity; i++) {
                        ydkLines.push(cardInfo.id.toString());
                    }
                }
            });

            // Extra Deck
            ydkLines.push("#extra");
            cardRequests.filter(req => req.type === 'extra').forEach(request => {
                const cardInfo = cardData.find(card => card.name === request.cardName);
                if (cardInfo) {
                    for (let i = 0; i < request.quantity; i++) {
                        ydkLines.push(cardInfo.id.toString());
                    }
                }
            });

            // Side Deck
            ydkLines.push("#side");
            cardRequests.filter(req => req.type === 'side').forEach(request => {
                const cardInfo = cardData.find(card => card.name === request.cardName);
                if (cardInfo) {
                    for (let i = 0; i < request.quantity; i++) {
                        ydkLines.push(cardInfo.id.toString());
                    }
                }
            });

            return ydkLines.join('\n').trim();
        }

        function createDownloadLink(content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = url;
            document.getElementById('downloadLinkContainer').style.display = 'block';
        }
    </script>
</body>
</html>
